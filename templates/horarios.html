{% extends "base.html" %}
{% block title %}Meus Horários - Opala Systems{% endblock %}
{% block content %}
    <div class="content-section">
        {# NOVO: Usando a classe main-content-title para o título da página #}
        <h2 class="main-content-title">Gerenciar Horários de Rega</h2> {# Alterado para h2 para semântica #}

        <!-- Formulário para Adicionar Novo Horário (Modal Trigger) -->
        <div class="mb-4 text-end"> {# Alinhado à direita para melhor visual #}
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNovoHorario">
                <i class="fas fa-plus me-2"></i> Adicionar Novo Horário
            </button>
        </div>

        {% if horarios %}
            <div class="table-responsive"> {# Tabela responsiva para melhor visualização em telas menores #}
                <table class="table table-hover table-striped">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>Duração (min)</th>
                            <th>Dias da Semana</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for horario in horarios %}
                            <tr>
                                <td>{{ horario.hora.strftime('%H:%M') }}</td> {# Formata o objeto time para string HH:MM #}
                                <td>{{ horario.duracao }}</td>
                                <td>{{ horario.dias_semana }}</td>
                                <td>
                                    {% if horario.ativo %}
                                        <span class="badge bg-success">Ativo</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Inativo</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('editar_horario', horario_id=horario.id) }}" class="btn btn-sm btn-info me-2">
                                        <i class="fas fa-edit"></i> Editar
                                    </a>
                                    <button type="button" class="btn btn-sm {% if horario.ativo %}btn-warning{% else %}btn-success{% endif %} me-2" onclick="toggleAtivo({{ horario.id }}, {{ 'false' if horario.ativo else 'true' }})">
                                        {% if horario.ativo %}<i class="fas fa-pause"></i> Desativar{% else %}<i class="fas fa-play"></i> Ativar{% endif %}
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger" onclick="deletarHorario({{ horario.id }})">
                                        <i class="fas fa-trash-alt"></i> Excluir
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-center">Nenhum horário de rega cadastrado ainda. Clique em "Adicionar Novo Horário" para começar!</p>
        {% endif %}
    </div>

    <!-- MODAL para Adicionar Horário -->
    <div class="modal fade" id="modalNovoHorario" tabindex="-1" aria-labelledby="novoHorarioLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="novoHorarioLabel">Adicionar Novo Horário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <form id="formNovoHorario">
                        <div class="mb-3">
                            <label for="novaHora" class="form-label">Hora (HH:MM)</label>
                            <input type="text" class="form-control" id="novaHora" name="hora" placeholder="07:30" pattern="^(?:2[0-3]|[01]?[0-9]):(?:[0-5]?[0-9])$" required>
                            <small class="form-text text-muted">Formato: HH:MM (ex: 08:30)</small>
                        </div>
                        <div class="mb-3">
                            <label for="novaDuracao" class="form-label">Duração (minutos)</label>
                            <input type="number" class="form-control" id="novaDuracao" name="duracao" min="1" max="1440" placeholder="10" required>
                            <small class="form-text text-muted">Duração da rega em minutos</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Dias da Semana</label>
                            <div class="row">
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="dias" value="Seg" id="seg" checked>
                                        <label class="form-check-label" for="seg">Seg</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="dias" value="Ter" id="ter" checked>
                                        <label class="form-check-label" for="ter">Ter</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="dias" value="Qua" id="qua" checked>
                                        <label class="form-check-label" for="qua">Qua</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="dias" value="Qui" id="qui" checked>
                                        <label class="form-check-label" for="qui">Qui</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="dias" value="Sex" id="sex" checked>
                                        <label class="form-check-label" for="sex">Sex</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="dias" value="Sab" id="sab">
                                        <label class="form-check-label" for="sab">Sáb</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="dias" value="Dom" id="dom">
                                        <label class="form-check-label" for="dom">Dom</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarNovoHorario()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function salvarNovoHorario() {
            const form = document.getElementById('formNovoHorario');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            const hora = document.getElementById('novaHora').value;
            const duracao = document.getElementById('novaDuracao').value;
            const diasChecks = document.querySelectorAll('input[name="dias"]:checked');
            const dias = Array.from(diasChecks).map(d => d.value).join(',');
            if (!dias) {
                alert('Selecione pelo menos um dia da semana.');
                return;
            }
            fetch('{{ url_for("adicionar_horario") }}', { // Usando url_for
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ hora, duracao, dias })
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    window.location.reload();
                } else {
                    alert('Erro: ' + data.erro);
                }
            })
            .catch(error => {
                console.error('Erro ao salvar horário:', error);
                alert('Erro ao salvar horário.');
            });
        }

        function deletarHorario(id) {
            if (!confirm('Tem certeza que deseja excluir este horário?')) return;
            fetch('{{ url_for("deletar_horario", horario_id=0) }}'.replace('0', id), { // Usando url_for
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    window.location.reload();
                } else {
                    alert('Erro: ' + data.erro);
                }
            })
            .catch(error => {
                console.error('Erro ao deletar horário:', error);
                alert('Erro ao deletar horário.');
            });
        }

        function toggleAtivo(id, novoEstado) {
            fetch('{{ url_for("ativar_horario", horario_id=0) }}'.replace('0', id), { // Usando url_for
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ ativo: novoEstado })
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    window.location.reload();
                } else {
                    alert('Erro: ' + data.erro);
                }
            })
            .catch(error => {
                console.error('Erro ao atualizar status:', error);
                alert('Erro ao atualizar status.');
            });
        }
    </script>
{% endblock content %}
