{% extends "base.html" %}
{% block title %}Meus Horários - Opala Systems{% endblock %}
{% block content %}
    <div class="content-section">
        {# NOVO: Usando a classe main-content-title para o título da página #}
        <div class="main-content-title">Meus Horários de Rega - Opala Systems</div>
        {% if horarios %}
            <ul class="list-group">
                {% for horario in horarios %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Horário:</strong> {{ horario.hora }} <br>
                            <strong>Duração:</strong> {{ horario.duracao }} minutos <br>
                            <strong>Dias:</strong> {{ horario.dias_semana }} <br>
                            <strong>Status:</strong>
                            {% if horario.ativo %}
                                <span class="badge bg-success">Ativo</span>
                            {% else %}
                                <span class="badge bg-secondary">Inativo</span>
                            {% endif %}
                        </div>
                        <div>
                            <!-- Botão/Link para Editar -->
                            <a href="{{ url_for('editar_horario', horario_id=horario.id) }}" class="btn btn-info btn-sm me-2">Editar</a>
                            <!-- Botão de Excluir -->
                            <button type="button" class="btn btn-danger btn-sm" onclick="deletarHorario({{ horario.id }})">Excluir</button>
                            <!-- Botão de Ativar/Desativar -->
                            <button type="button" class="btn btn-warning btn-sm" onclick="toggleAtivo({{ horario.id }}, {{ 'false' if horario.ativo else 'true' }})">
                                {% if horario.ativo %}Desativar{% else %}Ativar{% endif %}
                            </button>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>Nenhum horário de rega cadastrado ainda. Adicione um!</p>
        {% endif %}
        <!-- Botão para Adicionar Horário (abre um modal) -->
        <div class="mt-3 text-center">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNovoHorario">
                Adicionar Novo Horário
            </button>
        </div>
    </div>
    <!-- MODAL para Adicionar Horário (mantido do código anterior) -->
    <div class="modal fade" id="modalNovoHorario" tabindex="-1" aria-labelledby="novoHorarioLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="novoHorarioLabel">Adicionar Novo Horário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <form id="formNovoHorario">
                        <div class="mb-3">
                            <label for="novaHora" class="form-label">Hora (HH:MM)</label>
                            <input type="text" class="form-control" id="novaHora" name="hora" placeholder="07:30" pattern="^(?:2[0-3]|[01]?[0-9]):(?:[0-5]?[0-9])$" required>
                            <small class="form-text text-muted">Formato: HH:MM (ex: 08:30)</small>
                        </div>
                        <div class="mb-3">
                            <label for="novaDuracao" class="form-label">Duração (minutos)</label>
                            <input type="number" class="form-control" id="novaDuracao" name="duracao" min="1" max="1440" placeholder="10" required>
                            <small class="form-text text-muted">Duração da rega em minutos</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Dias da Semana</label>
                            <div class="row">
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="dias" value="Seg" id="seg" checked>
                                        <label class="form-check-label" for="seg">Seg</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="dias" value="Ter" id="ter">
                                        <label class="form-check-label" for="ter">Ter</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="dias" value="Qua" id="qua">
                                        <label class="form-check-label" for="qua">Qua</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="dias" value="Qui" id="qui">
                                        <label class="form-check-label" for="qui">Qui</label>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="dias" value="Sex" id="sex" checked>
                                        <label class="form-check-label" for="sex">Sex</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="dias" value="Sab" id="sab">
                                        <label class="form-check-label" for="sab">Sáb</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="dias" value="Dom" id="dom">
                                        <label class="form-check-label" for="dom">Dom</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarNovoHorario()">Salvar</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        function salvarNovoHorario() {
            const form = document.getElementById('formNovoHorario');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            const hora = document.getElementById('novaHora').value;
            const duracao = document.getElementById('novaDuracao').value;
            const diasChecks = document.querySelectorAll('input[name="dias"]:checked');
            const dias = Array.from(diasChecks).map(d => d.value).join(',');
            if (!dias) {
                alert('Selecione pelo menos um dia da semana.');
                return;
            }
            fetch('/adicionar_horario', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ hora, duracao, dias })
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    window.location.reload();
                } else {
                    alert('Erro: ' + data.erro);
                }
            })
            .catch(error => {
                console.error('Erro ao salvar horário:', error);
                alert('Erro ao salvar horário.');
            });
        }

        function deletarHorario(id) {
            if (!confirm('Tem certeza que deseja excluir este horário?')) return;
            fetch('/deletar_horario/' + id, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    window.location.reload();
                } else {
                    alert('Erro: ' + data.erro);
                }
            })
            .catch(error => {
                console.error('Erro ao deletar horário:', error);
                alert('Erro ao deletar horário.');
            });
        }

        function toggleAtivo(id, novoEstado) {
            fetch('/ativar_horario/' + id, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ ativo: novoEstado })
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    window.location.reload();
                } else {
                    alert('Erro: ' + data.erro);
                }
            })
            .catch(error => {
                console.error('Erro ao atualizar status:', error);
                alert('Erro ao atualizar status.');
            });
        }
    </script>
{% endblock content %}
